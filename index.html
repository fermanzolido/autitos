<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Concesionarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilo para una transición suave al mostrar/ocultar elementos */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-out { animation: fadeOut 0.3s ease-in-out; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container"></div>

    <script type="module">
        // --- SDKs de Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import {
            getFirestore, collection, onSnapshot, doc, addDoc,
            updateDoc, deleteDoc, writeBatch, serverTimestamp, query, where, arrayUnion
        } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-functions.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

        // --- INSTRUCCIONES DE CONFIGURACIÓN ---
        // 1. Reemplaza este objeto `firebaseConfig` con la configuración de tu propio proyecto de Firebase.
        // 2. Habilita la autenticación por Email/Contraseña en tu proyecto de Firebase.
        // 3. Configura las reglas de Firestore para mayor seguridad en producción.
        // 4. Para que los roles (admin, factory, dealer) funcionen, debes configurar Custom Claims
        //    para los usuarios en Firebase. Esto generalmente se hace a través de una Cloud Function
        //    que se dispara al crear un usuario o mediante el Admin SDK en un backend.
        //    Ejemplo con el Admin SDK (en un entorno Node.js):
        //    admin.auth().setCustomUserClaims(uid, { role: 'admin', dealerId: 'some-dealer-id' });
        
        // --- CONFIGURACIÓN DE TU PROYECTO DE FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBDrnsoTrh4lHw6q0-wPUPowUI37164vEw",
            authDomain: "autitos-82ad2.firebaseapp.com",
            projectId: "autitos-82ad2",
            storageBucket: "autitos-82ad2.appspot.com", // Corregido: suele ser .appspot.com
            messagingSenderId: "1073855461143",
            appId: "1:1073855461143:web:b15858452517829d786952",
            measurementId: "G-LLDF0B72DJ"
        };

        // --- INICIALIZACIÓN DE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);
        const analytics = getAnalytics(app);

        // --- ESTADO GLOBAL DE LA APLICACIÓN ---
        const state = {
            user: null,
            role: null,
            userClaims: null,
            authLoading: true,
            currentPage: 'dashboard',
            collections: {
                vehicles: [],
                dealers: [],
                customers: [],
                sales: [],
                availableVehicles: [],
                interactions: [],
                b2b_invoices: [],
                forecasts: [],
                factory_orders: [],
            },
            collectionsLoading: {
                vehicles: true,
                dealers: true,
                customers: true,
                sales: true,
                availableVehicles: true,
                interactions: true,
                b2b_invoices: true,
                forecasts: true,
                factory_orders: true,
            },
            filters: {
                vehicles: { status: [], make: '', model: '', daysInStock_greaterThan: '' }
            },
            notification: { message: '', type: '' },
            isModalOpen: false,
            editingItem: null,
            isNewCustomerSale: false,
            pagination: {
                vehicles: { currentPage: 1, itemsPerPage: 10 },
                customers: { currentPage: 1, itemsPerPage: 10 },
                sales: { currentPage: 1, itemsPerPage: 10 },
            },
            ui: {
                tableDensity: 'default', // 'default' or 'compact'
                visibleVehicleColumns: ['make_model', 'vin_price', 'status', 'actions'],
            }
        };

        // Contenedor principal de la aplicación
        const appContainer = document.getElementById('app-container');
        let firestoreUnsubscribers = [];

        // --- FUNCIONES DE RENDERIZADO (Generan HTML) ---

        const SpinnerHTML = () => `
            <div class="flex justify-center items-center h-full">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            </div>`;

        const NotificationHTML = () => {
            if (!state.notification.message) return '';
            const typeClasses = { success: "bg-green-500", error: "bg-red-500" };
            return `
                <div class="fixed top-5 right-5 p-4 rounded-md shadow-lg text-white transition-opacity duration-300 z-50 ${typeClasses[state.notification.type]}">
                    <span>${state.notification.message}</span>
                    <button onclick="window.app.dismissNotification()" class="ml-4 font-bold">X</button>
                </div>`;
        };
        
        const ModalHTML = (title, content) => {
            if (!state.isModalOpen) return '';
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center fade-in">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">${title}</h2>
                            <button onclick="window.app.closeModal()" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
                        </div>
                        ${content}
                    </div>
                </div>`;
        };

        // --- RENDERIZADO DE PÁGINAS ---
        
        function renderLoginPage() {
            appContainer.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gray-100">
                    <div class="p-8 bg-white rounded-lg shadow-md w-full max-w-sm">
                        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Iniciar Sesión</h2>
                        <form onsubmit="window.app.handleLogin(event)">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="email">Email</label>
                                <input id="email" type="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required />
                            </div>
                            <div class="mb-6">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="password">Contraseña</label>
                                <input id="password" type="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required />
                            </div>
                            <button id="login-button" type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full disabled:bg-blue-300">
                                Iniciar Sesión
                            </button>
                        </form>
                    </div>
                    ${NotificationHTML()}
                </div>`;
        }

        function renderMainLayout() {
            const navLinks = [
                { name: 'Dashboard', page: 'dashboard', roles: ['admin', 'factory', 'dealer'] },
                { name: 'Vehículos', page: 'vehicles', roles: ['admin', 'factory', 'dealer'] },
                { name: 'Concesionarios', page: 'dealers', roles: ['admin', 'factory'] },
                { name: 'Facturación B2B', page: 'b2bInvoices', roles: ['admin', 'factory'] },
                { name: 'Análisis BI', page: 'biDashboard', roles: ['admin', 'factory'] },
                { name: 'Pronósticos', page: 'forecasts', roles: ['admin', 'factory'] },
                { name: 'Clientes', page: 'customers', roles: ['admin', 'dealer'] },
                { name: 'Ventas', page: 'sales', roles: ['admin', 'dealer'] },
                { name: 'Pedidos de Fábrica', page: 'factoryOrders', roles: ['dealer'] },
                { name: 'Gestión de Pedidos', page: 'factoryOrdersAdmin', roles: ['admin', 'factory'] },
                { name: 'Seguimientos', page: 'scheduledFollowUps', roles: ['admin', 'dealer'] },
                { name: 'Reportes', page: 'reports', roles: ['admin'] },
            ];

            const sidebar = `
                <div class="w-64 bg-gray-800 text-white flex flex-col min-h-screen">
                    <div class="p-4 text-2xl font-bold border-b border-gray-700">Concesionario</div>
                    <nav class="flex-1 p-2">
                        ${navLinks.filter(l => l.roles.includes(state.role)).map(link => `
                            <a href="#" onclick="event.preventDefault(); window.app.setCurrentPage('${link.page}')"
                                class="block py-2.5 px-4 rounded ${state.currentPage === link.page ? 'bg-gray-700' : 'hover:bg-gray-700'}">
                                ${link.name}
                            </a>
                        `).join('')}
                    </nav>
                    <div class="p-4 border-t border-gray-700">
                        <button onclick="window.app.handleLogout()" class="w-full bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                            Cerrar Sesión
                        </button>
                    </div>
                </div>`;
            
            appContainer.innerHTML = `
                <div class="flex bg-gray-100">
                    ${sidebar}
                    <main id="page-content" class="flex-1 p-8 overflow-y-auto h-screen"></main>
                </div>
                <div id="modal-container"></div>
                <div id="notification-container">${NotificationHTML()}</div>
            `;
            renderCurrentPage();
        }
        
        function renderCurrentPage() {
            const pageContent = document.getElementById('page-content');
            if (!pageContent) return;

            const pages = {
                dashboard: DashboardPageHTML,
                vehicles: VehiclesPageHTML,
                dealers: DealersPageHTML,
                customers: CustomersPageHTML,
                sales: SalesPageHTML,
                reports: ReportsPageHTML,
                factoryOrders: FactoryOrdersPageHTML,
                factoryOrdersAdmin: FactoryOrdersAdminPageHTML,
                b2bInvoices: B2BInvoicesPageHTML,
                biDashboard: BIDashboardPageHTML,
                forecasts: ForecastsPageHTML,
                scheduledFollowUps: ScheduledFollowUpsPageHTML,
            };

            const renderFunc = pages[state.currentPage] || DashboardPageHTML;
            pageContent.innerHTML = renderFunc();
            // Si la página es de reportes, renderizamos el gráfico después de que el HTML esté en el DOM
            if (state.currentPage === 'reports') {
                appController.renderSalesReport();
            }
            if (state.currentPage === 'biDashboard') {
                appController.renderBITopCharts();
            }
            if (state.currentPage === 'dashboard' && state.role === 'dealer') {
                appController.renderDealerSalesChart();
            }
        }

        // --- HTML PARA CADA PÁGINA ---

        function ReportsPageHTML() {
            return `
                <div>
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Reportes y Analíticas</h1>

                    <div class="bg-white p-6 rounded-lg shadow mb-8">
                        <h2 class="text-xl font-semibold mb-4">Ventas</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="date" id="startDate" class="p-2 border rounded" onchange="window.app.renderSalesReport()">
                            <input type="date" id="endDate" class="p-2 border rounded" onchange="window.app.renderSalesReport()">
                        </div>
                        <canvas id="salesChart"></canvas>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow">
                        <h2 class="text-xl font-semibold mb-4">Exportar Datos</h2>
                        <div class="flex space-x-4">
                            <button onclick="window.app.exportToCSV(state.collections.vehicles, 'vehiculos.csv')" class="bg-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded">
                                Exportar Vehículos (CSV)
                            </button>
                            <button onclick="window.app.exportToCSV(state.collections.sales, 'ventas.csv')" class="bg-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded">
                                Exportar Ventas (CSV)
                            </button>
                            <button onclick="window.app.exportToCSV(state.collections.customers, 'clientes.csv')" class="bg-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded">
                                Exportar Clientes (CSV)
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function DashboardPageHTML() {
            const stats = {
                vehiclesInStock: state.collections.vehicles.filter(v => v.status !== 'vendido').length,
                totalSales: state.collections.sales.length,
                totalDealers: state.collections.dealers.length,
                avgDaysInStock: (state.role === 'admin' || state.role === 'factory') ? appController.calculateAverageDaysInStock() : 0,
            };

            if (state.role === 'dealer') {
                const dealer = state.collections.dealers.find(d => d.id === state.userClaims.dealerId);
                stats.dealerAvgDaysInStock = appController.calculateAvgDaysInStockForDealer(dealer.id);
                stats.territoryAvgDaysInStock = appController.calculateAvgDaysInStockForTerritory(dealer.territory);
            }

             return `
                <div>
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Dashboard</h1>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        ${(state.role === 'admin' || state.role === 'factory') ? `
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold">Vehículos en Stock</h3><p class="text-4xl font-bold text-blue-600">${stats.vehiclesInStock}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold">Ventas Totales</h3><p class="text-4xl font-bold text-green-600">${stats.totalSales}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold">Días Promedio en Stock (Red)</h3>
                                <p class="text-4xl font-bold text-orange-600">${stats.avgDaysInStock}</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold">Concesionarios</h3><p class="text-4xl font-bold text-purple-600">${stats.totalDealers}</p></div>
                        ` : ''}

                        ${(state.role === 'dealer') ? `
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold">Vehículos en Stock</h3><p class="text-4xl font-bold text-blue-600">${stats.vehiclesInStock}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-semibold">Ventas Totales</h3><p class="text-4xl font-bold text-green-600">${stats.totalSales}</p></div>
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold">Mis Días Promedio en Stock</h3>
                                <p class="text-4xl font-bold text-indigo-600">${stats.dealerAvgDaysInStock}</p>
                            </div>
                             <div class="bg-white p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold">Días Promedio en Stock (Territorio)</h3>
                                <p class="text-4xl font-bold text-gray-600">${stats.territoryAvgDaysInStock}</p>
                            </div>
                        ` : ''}
                    </div>
                    ${(state.role === 'dealer') ? `
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4">Mi Tendencia de Ventas (Últimos 6 meses)</h3>
                        <canvas id="dealerSalesChart"></canvas>
                    </div>
                    ` : ''}
                </div>`;
        }

        function VehiclesPageHTML() {
            if (state.collectionsLoading.vehicles) return SpinnerHTML();
            
            const { status, make, model, daysInStock_greaterThan } = state.filters.vehicles;
            const filteredVehicles = state.collections.vehicles.filter(v => {
                const statusMatch = status.length === 0 || status.includes(v.status);
                const makeMatch = make ? v.make.toLowerCase().includes(make.toLowerCase()) : true;
                const modelMatch = model ? v.model.toLowerCase().includes(model.toLowerCase()) : true;

                let daysInStockMatch = true;
                if (daysInStock_greaterThan && v.statusHistory && v.status !== 'vendido') {
                    // This is a client-side calculation and can be slow on very large datasets.
                    // It calculates days since the *last* status change.
                    const lastStatusUpdate = v.statusHistory[v.statusHistory.length - 1].date.toDate();
                    const now = new Date();
                    const diffTime = Math.abs(now - lastStatusUpdate);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    daysInStockMatch = diffDays > Number(daysInStock_greaterThan);
                }

                return statusMatch && makeMatch && modelMatch && daysInStockMatch;
            });

            const { currentPage, itemsPerPage } = state.pagination.vehicles;
            const paginatedVehicles = filteredVehicles.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            const getStatusBadge = (vehicleStatus) => {
                const styles = {
                    vendido: 'bg-red-100 text-red-800',
                    enConcesionario: 'bg-green-100 text-green-800',
                    default: 'bg-yellow-100 text-yellow-800'
                };
                return styles[vehicleStatus] || styles.default;
            };

            const cellPadding = state.ui.tableDensity === 'compact' ? 'px-4 py-2' : 'px-6 py-4';
            const tableRows = paginatedVehicles.map(v => `
                <tr key=${v.id}>
                    ${state.ui.visibleVehicleColumns.includes('make_model') ? `<td class="${cellPadding}">${v.make} ${v.model} ${v.trim || ''}</td>` : ''}
                    ${state.ui.visibleVehicleColumns.includes('vin_price') ? `<td class="${cellPadding}">${v.vin}<br/>$${(v.price || 0).toLocaleString()}</td>` : ''}
                    ${state.ui.visibleVehicleColumns.includes('status') ? `<td class="${cellPadding}">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadge(v.status)}">
                            ${v.status}
                        </span>
                    </td>` : ''}
                    ${state.ui.visibleVehicleColumns.includes('actions') ? `<td class="${cellPadding} text-sm font-medium">
                        ${(state.role === 'admin' || state.role === 'factory') ? `
                            <div class="flex items-center space-x-2">
                                <button onclick="window.app.openVehicleModal('${v.id}')" class="text-indigo-600 hover:text-indigo-900">Editar</button>
                                <button onclick="window.app.handleDeleteVehicle('${v.id}')" class="text-red-600 hover:text-red-900">Eliminar</button>
                                <select onchange="window.app.handleAssignDealer('${v.id}', this.value)" class="border p-1 rounded text-xs">
                                    <option value="" ${!v.dealerId ? 'selected' : ''} disabled>Asignar...</option>
                                    ${state.collections.dealers.map(d => `<option value="${d.id}" ${v.dealerId === d.id ? 'selected' : ''}>${d.name}</option>`).join('')}
                                </select>
                            </div>
                        ` : ''}
                        ${(state.role === 'dealer' && v.status === 'asignado') ? `
                            <button onclick="window.app.handleConfirmOrder('${v.id}')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs">
                                Confirmar Pedido
                            </button>
                        ` : ''}
                        ${(state.role === 'dealer' && v.status === 'enTransito') ? `
                            <button onclick="window.app.handleReceiveVehicle('${v.id}')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-xs">
                                Recibir Vehículo
                            </button>
                        ` : ''}
                        ${(state.role === 'dealer' && v.status !== 'asignado' && v.status !== 'enTransito') ? `<span class="text-gray-500">Sin acciones</span>` : ''}
                    </td>` : ''}
                </tr>
            `).join('');

            return `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Gestión de Vehículos</h1>
                        <div class="flex items-center space-x-4">
                            <div class="relative inline-block text-left">
                                <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-sm text-gray-600 hover:text-gray-900">Columnas</button>
                                <div class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                                    <div class="py-1" role="menu" aria-orientation="vertical">
                                        ${['make_model', 'vin_price', 'status', 'actions'].map(col => `
                                            <a href="#" class="block px-4 py-2 text-sm text-gray-700">
                                                <label class="inline-flex items-center">
                                                    <input type="checkbox" onchange="window.app.toggleVehicleColumn('${col}')"
                                                           ${state.ui.visibleVehicleColumns.includes(col) ? 'checked' : ''} class="form-checkbox">
                                                    <span class="ml-2">${col.replace('_', ' ')}</span>
                                                </label>
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                            <button onclick="window.app.toggleTableDensity()" class="text-sm text-gray-600 hover:text-gray-900">
                                Vista ${state.ui.tableDensity === 'compact' ? 'Normal' : 'Compacta'}
                            </button>
                            ${(state.role === 'admin' || state.role === 'factory') ? `
                                <button onclick="window.app.openVehicleModal()" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Añadir Vehículo</button>
                            ` : ''}
                        </div>
                    </div>

                    <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 bg-white p-4 rounded-lg shadow">
                        <input type="text" placeholder="Filtrar por Marca" oninput="window.app.updateVehicleFilter('make', this.value)" value="${make}" class="border p-2 rounded"/>
                        <input type="text" placeholder="Filtrar por Modelo" oninput="window.app.updateVehicleFilter('model', this.value)" value="${model}" class="border p-2 rounded"/>
                        <input type="number" placeholder="Días en stock >" oninput="window.app.updateVehicleFilter('daysInStock_greaterThan', this.value)" value="${state.filters.vehicles.daysInStock_greaterThan}" class="border p-2 rounded"/>
                        <div class="col-span-1 md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Estado:</label>
                            <div class="flex flex-wrap gap-x-4 gap-y-2">
                                ${['enFabrica', 'asignado', 'enPuerto', 'enTransito', 'enConcesionario', 'vendido'].map(s => `
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" onchange="window.app.updateVehicleStatusFilter('${s}', this.checked)"
                                               ${status.includes(s) ? 'checked' : ''} class="form-checkbox h-5 w-5 text-blue-600">
                                        <span class="ml-2 text-gray-700">${s}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    ${state.ui.visibleVehicleColumns.includes('make_model') ? `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca/Modelo</th>` : ''}
                                    ${state.ui.visibleVehicleColumns.includes('vin_price') ? `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">VIN/Precio</th>` : ''}
                                    ${state.ui.visibleVehicleColumns.includes('status') ? `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>` : ''}
                                    ${state.ui.visibleVehicleColumns.includes('actions') ? `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>` : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                        </table>
                        ${PaginationHTML('vehicles', filteredVehicles.length)}
                    </div>
                </div>`;
        }
        
        // ... Implementar HTML para las otras páginas (Dealers, Customers, Sales) de manera similar
        // Por brevedad, se omiten aquí, pero la estructura sigue el mismo patrón.
        function DealersPageHTML() {
             if (state.collectionsLoading.dealers) return SpinnerHTML();
             if (state.role !== 'admin' && state.role !== 'factory') {
                 return `<div class="p-4">Acceso denegado. No tienes permisos para ver esta página.</div>`;
             }
             
             const tableRows = state.collections.dealers.map(d => `
                <tr key=${d.id}>
                    <td class="px-6 py-4 whitespace-nowrap">${d.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${d.address}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${d.territory}</td>
                    <td class="px-6 py-4 whitespace-nowrap">$${(d.creditLine || 0).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap">$${(d.availableCredit || 0).toLocaleString()}</td>
                    ${state.role === 'admin' ? `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="window.app.openDealerModal('${d.id}')" class="text-indigo-600 hover:text-indigo-900">Editar</button>
                            <button onclick="window.app.handleDeleteDealer('${d.id}')" class="text-red-600 hover:text-red-900 ml-4">Eliminar</button>
                        </td>
                    ` : ''}
                </tr>
            `).join('');

             return `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Gestión de Concesionarios</h1>
                        ${state.role === 'admin' ? `
                            <button onclick="window.app.openDealerModal()" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Añadir Concesionario</button>
                        ` : ''}
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dirección</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Territorio</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Línea de Crédito</th>
                                     <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Crédito Disponible</th>
                                    ${state.role === 'admin' ? '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                        </table>
                        ${PaginationHTML('customers', state.collections.customers.length)}
                    </div>
                </div>
             `;
        }

        function CustomersPageHTML() {
            if (state.collectionsLoading.customers) return SpinnerHTML();
            if (state.role !== 'admin' && state.role !== 'dealer') {
                return `<div class="p-4">Acceso denegado.</div>`;
            }

            const { currentPage, itemsPerPage } = state.pagination.customers;
            const paginatedCustomers = state.collections.customers.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            const tableRows = paginatedCustomers.map(c => `
                <tr key=${c.id}>
                    <td class="px-6 py-4 whitespace-nowrap">${c.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${c.dni}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${c.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${c.phone}</td>
                    ${state.role === 'admin' ? `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="window.app.openCustomerModal('${c.id}')" class="text-indigo-600 hover:text-indigo-900">Editar</button>
                            <button onclick="window.app.handleDeleteCustomer('${c.id}')" class="text-red-600 hover:text-red-900 ml-4">Eliminar</button>
                            <button onclick="window.app.openCustomerDetailModal('${c.id}')" class="text-blue-600 hover:text-blue-900 ml-4">Ver</button>
                        </td>
                    ` : ''}
                </tr>
            `).join('');

            return `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Gestión de Clientes</h1>
                        <button onclick="window.app.openCustomerModal()" class="bg-blue-500 text-white px-4 py-2 rounded shadow">Añadir Cliente</button>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">DNI</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Teléfono</th>
                                    ${state.role === 'admin' ? '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function ScheduledFollowUpsPageHTML() {
            if (state.role !== 'admin' && state.role !== 'dealer') {
                return `<div class="p-4">Acceso denegado.</div>`;
            }

            const pendingFollowUps = state.collections.interactions
                .filter(i => i.followUpStatus === 'pending')
                .sort((a, b) => a.followUpDate.toDate() - b.followUpDate.toDate());

            const tableRows = pendingFollowUps.map(i => {
                const customer = state.collections.customers.find(c => c.id === i.customerId);
                return `
                    <tr key=${i.id}>
                        <td class="px-6 py-4 whitespace-nowrap">${i.followUpDate.toDate().toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer ? customer.name : 'N/A'}</td>
                        <td class="px-6 py-4">${i.notes}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                             <button onclick="window.app.handleCompleteFollowUp('${i.id}')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                                Marcar Completado
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div>
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Seguimientos Agendados</h1>
                    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha de Seguimiento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function ForecastsPageHTML() {
            if (state.role !== 'admin' && state.role !== 'factory') {
                return `<div class="p-4">Acceso denegado.</div>`;
            }

            const forecastsRows = state.collections.forecasts.sort((a, b) => a.month.localeCompare(b.month)).map(f => `
                <tr key=${f.id}>
                    <td class="px-6 py-4 whitespace-nowrap">${f.month}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${f.target}</td>
                </tr>
            `).join('');

            return `
                <div>
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Gestión de Pronósticos de Ventas</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold mb-4">Añadir Nuevo Pronóstico</h2>
                            <form onsubmit="window.app.handleSaveForecast(event)" class="space-y-4">
                                <input type="month" name="month" class="border p-2 rounded w-full" required />
                                <input type="number" name="target" placeholder="Objetivo de Ventas (unidades)" class="border p-2 rounded w-full" required />
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Guardar Pronóstico</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                             <h2 class="text-xl font-semibold mb-4">Pronósticos Guardados</h2>
                             <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Mes</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Objetivo</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">${forecastsRows}</tbody>
                             </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function BIDashboardPageHTML() {
             if (state.role !== 'admin' && state.role !== 'factory') {
                return `<div class="p-4">Acceso denegado.</div>`;
            }

            // Placeholder for KPIs and charts
            const turnoverRate = appController.calculateInventoryTurnoverRate();

            return `
                <div>
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Análisis de Negocio (BI)</h1>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold">Tasa de Rotación de Inventario (Últimos 90 días)</h3>
                            <p class="text-4xl font-bold text-teal-600">${turnoverRate}</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4">Ventas por Territorio</h3>
                        <canvas id="salesByTerritoryChart"></canvas>
                    </div>
                </div>
            `;
        }

        function B2BInvoicesPageHTML() {
            if (state.collectionsLoading.b2b_invoices || state.collectionsLoading.vehicles || state.collectionsLoading.dealers) return SpinnerHTML();
            if (state.role !== 'admin' && state.role !== 'factory') {
                return `<div class="p-4">Acceso denegado.</div>`;
            }

            const tableRows = state.collections.b2b_invoices.map(invoice => {
                const vehicle = state.collections.vehicles.find(v => v.id === invoice.vehicleId);
                const dealer = state.collections.dealers.find(d => d.id === invoice.dealerId);
                return `
                    <tr key=${invoice.id}>
                        <td class="px-6 py-4 whitespace-nowrap">${invoice.date ? invoice.date.toDate().toLocaleDateString() : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${dealer ? dealer.name : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${vehicle ? `${vehicle.make} ${vehicle.model}` : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">$${(invoice.price || 0).toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${invoice.status}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${invoice.documentURL ? `<a href="${invoice.documentURL}" target="_blank" class="text-blue-600 hover:underline">Ver Documento</a>` : 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            ${invoice.status === 'pendiente' ? `
                                <button onclick="window.app.handleMarkInvoiceAsPaid('${invoice.id}')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-2 rounded text-xs">
                                    Marcar como Pagada
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div>
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Facturación B2B</h1>
                    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Concesionario</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehículo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monto</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Documento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function FactoryOrdersPageHTML() {
            if (state.collectionsLoading.factory_orders) return SpinnerHTML();
            if (state.role !== 'dealer') {
                return `<div class="p-4">Acceso denegado.</div>`;
            }

            const dealerOrders = state.collections.factory_orders.filter(o => o.dealerId === state.userClaims.dealerId);

            const tableRows = dealerOrders.map(o => `
                <tr key=${o.id}>
                    <td class="px-6 py-4 whitespace-nowrap">${o.make}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${o.model}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${o.trim}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${o.color}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${o.status}</td>
                </tr>
            `).join('');

            return `
                <div>
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Pedidos de Fábrica</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h2 class="text-xl font-semibold mb-4">Solicitar Nuevo Vehículo</h2>
                            <form onsubmit="window.app.handleCreateFactoryOrder(event)" class="space-y-4">
                                <input name="make" placeholder="Marca" class="border p-2 rounded w-full" required />
                                <input name="model" placeholder="Modelo" class="border p-2 rounded w-full" required />
                                <input name="trim" placeholder="Equipamiento (Trim)" class="border p-2 rounded w-full" />
                                <input name="color" placeholder="Color" class="border p-2 rounded w-full" />
                                <textarea name="options" placeholder="Opciones adicionales" class="border p-2 rounded w-full"></textarea>
                                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Enviar Solicitud</button>
                            </form>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                        <h2 class="text-xl font-semibold mb-4">Mis Pedidos</h2>
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Marca</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Modelo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Equipamiento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Color</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function FactoryOrdersAdminPageHTML() {
            if (state.collectionsLoading.factory_orders || state.collectionsLoading.vehicles) return SpinnerHTML();
            if (state.role !== 'admin' && state.role !== 'factory') {
                return `<div class="p-4">Acceso denegado.</div>`;
            }

            const pendingOrders = state.collections.factory_orders.filter(o => o.status === 'pendiente');
            const availableVehicles = state.collections.vehicles.filter(v => !v.dealerId && v.status === 'enFabrica');

            const tableRows = pendingOrders.map(o => {
                const dealer = state.collections.dealers.find(d => d.id === o.dealerId);
                return `
                    <tr key=${o.id}>
                        <td class="px-6 py-4 whitespace-nowrap">${dealer ? dealer.name : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${o.make} ${o.model}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${o.trim}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${o.color}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <select id="vehicle-for-${o.id}" class="border p-1 rounded text-xs">
                                <option value="">Seleccionar vehículo...</option>
                                ${availableVehicles.map(v => `<option value="${v.id}">${v.make} ${v.model} (${v.vin})</option>`).join('')}
                            </select>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="window.app.handleMatchFactoryOrder('${o.id}')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded text-xs">
                                Emparejar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            return `
                <div>
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Gestión de Pedidos de Fábrica</h1>
                    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Concesionario</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehículo Solicitado</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Equipamiento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Color</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Asignar Vehículo de Inventario</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${tableRows}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function SalesPageHTML() {
             if (state.collectionsLoading.sales || state.collectionsLoading.customers || state.collectionsLoading.availableVehicles) return SpinnerHTML();
            
            const newCustomerForm = `
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border rounded-md">
                    <input name="name" placeholder="Nombre Completo" class="p-2 border rounded" required/>
                    <input name="dni" placeholder="DNI" class="p-2 border rounded" required/>
                    <input name="email" type="email" placeholder="Email" class="p-2 border rounded" />
                    <input name="phone" placeholder="Teléfono" class="p-2 border rounded" />
                    <input name="gender" placeholder="Género" class="p-2 border rounded" />
                    <input name="birth_date" type="date" placeholder="Fecha de Nacimiento" class="p-2 border rounded" />
                </div>
            `;

            const existingCustomerSelect = `
                <div>
                    <label class="block text-sm font-medium text-gray-700">Cliente Existente</label>
                    <select name="customerId" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="" disabled selected>Seleccione un cliente</option>
                        ${state.collections.customers.map(c => `<option value="${c.id}">${c.name} (${c.dni})</option>`).join('')}
                    </select>
                </div>
            `;

             const { currentPage, itemsPerPage } = state.pagination.sales;
             const paginatedSales = state.collections.sales.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

             const salesHistoryRows = paginatedSales.map(s => {
                const vehicle = state.collections.vehicles.find(v => v.id === s.vehicleId);
                const customer = state.collections.customers.find(c => c.id === s.customerId);
                return `
                    <tr key=${s.id}>
                        <td class="px-6 py-4 whitespace-nowrap">${s.saleDate?.toDate().toLocaleDateString() || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${vehicle ? `${vehicle.make} ${vehicle.model}` : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer ? customer.name : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">$${s.finalPrice.toLocaleString()}</td>
                    </tr>
                `;
             }).join('');

             return `
                <div>
                    <h1 class="text-3xl font-bold mb-6 text-gray-800">Gestión de Ventas</h1>
                    ${(state.role === 'dealer' || state.role === 'admin') ? `
                        <div class="bg-white p-6 rounded-lg shadow mb-8">
                            <h2 class="text-xl font-semibold mb-4">Registrar Nueva Venta</h2>
                            <form onsubmit="window.app.handleRegisterSale(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Vehículo</label>
                                    <select name="vehicleId" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                        <option value="" disabled selected>Seleccione un vehículo</option>
                                        ${state.collections.availableVehicles.map(v => `<option value="${v.id}">${v.make} ${v.model} (${v.vin})</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <div class="flex items-center mb-2">
                                        <input type="checkbox" id="newCustomer" onchange="window.app.toggleNewCustomerSale(this.checked)" ${state.isNewCustomerSale ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded"/>
                                        <label for="newCustomer" class="ml-2 block text-sm text-gray-900">Crear Nuevo Cliente</label>
                                    </div>
                                    <div id="customer-form-container">
                                        ${state.isNewCustomerSale ? newCustomerForm : existingCustomerSelect}
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Precio Final</label>
                                    <input type="number" name="finalPrice" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required/>
                                </div>
                                <div class="border-t pt-4 mt-4">
                                     <h3 class="text-md font-semibold mb-2">Información Adicional de la Venta (Opcional)</h3>
                                     <div class="space-y-4">
                                        <select name="financing_method" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                            <option value="" disabled selected>Método de Financiación</option>
                                            <option value="cash">Efectivo</option>
                                            <option value="internal_financing">Financiación Interna</option>
                                            <option value="external_financing">Financiación Externa</option>
                                        </select>
                                        <div class="p-4 border rounded-md">
                                            <h4 class="font-semibold">Datos del Vehículo de Canje (Trade-in)</h4>
                                            <div class="grid grid-cols-2 gap-4 mt-2">
                                                <input name="trade_in_make" placeholder="Marca" class="p-2 border rounded" />
                                                <input name="trade_in_model" placeholder="Modelo" class="p-2 border rounded" />
                                                <input name="trade_in_vin" placeholder="VIN" class="p-2 border rounded" />
                                                <input name="trade_in_value" type="number" placeholder="Valor" class="p-2 border rounded" />
                                            </div>
                                        </div>
                                     </div>
                                </div>
                                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded w-full">
                                    Registrar Venta
                                </button>
                            </form>
                        </div>
                    ` : ''}
                    <div class="bg-white p-4 rounded-lg shadow overflow-x-auto">
                        <h2 class="text-xl font-semibold mb-4">Historial de Ventas</h2>
                        <table class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehículo</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio Final</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">${salesHistoryRows}</tbody>
                        </table>
                        ${PaginationHTML('sales', state.collections.sales.length)}
                    </div>
                </div>
             `;
        }

        // --- FUNCIONES DE MODAL ---

        function renderModal() {
            const modalContainer = document.getElementById('modal-container');
            if(!modalContainer) return;
            
            let title = '', content = '';
            if (state.isModalOpen && state.editingItem) {
                const { type, data } = state.editingItem;
                switch(type) {
                    case 'vehicle':
                        title = data.id ? 'Editar Vehículo' : 'Añadir Vehículo';
                        content = VehicleFormHTML(data);
                        break;
                    case 'dealer':
                        title = data.id ? 'Editar Concesionario' : 'Añadir Concesionario';
                        content = DealerFormHTML(data);
                        break;
                    case 'customer':
                        title = data.id ? 'Editar Cliente' : 'Añadir Cliente';
                        content = CustomerFormHTML(data);
                        break;
                    case 'customerDetail':
                        title = `Detalle de Cliente: ${data.customer.name}`;
                        content = CustomerDetailModalHTML(data.customer, data.sales, data.interactions);
                        break;
                }
            }
             modalContainer.innerHTML = ModalHTML(title, content);
        }

        function CustomerDetailModalHTML(customer, sales, interactions) {
            const salesHTML = sales.map(sale => `
                <li class="border-b py-2 space-y-1">
                    <p><b>Vehículo:</b> ${sale.vehicle ? `${sale.vehicle.make} ${sale.vehicle.model}` : 'N/A'}</p>
                    <p><b>Fecha de Venta:</b> ${sale.saleDate ? sale.saleDate.toDate().toLocaleDateString() : 'N/A'}</p>
                    <p><b>Precio Final:</b> $${sale.finalPrice.toLocaleString()}</p>
                    ${sale.financing_method ? `<p><b>Financiación:</b> ${sale.financing_method}</p>` : ''}
                    ${sale.trade_in_vin ? `<p class="text-sm text-gray-600 pl-2">↳ <b>Trade-in:</b> ${sale.trade_in_make} ${sale.trade_in_model} (Valor: $${(sale.trade_in_value || 0).toLocaleString()})</p>` : ''}
                </li>
            `).join('');

            const interactionsHTML = interactions.map(interaction => `
                <li class="border-b py-2">
                    <p><b>Fecha:</b> ${interaction.date ? interaction.date.toDate().toLocaleDateString() : 'N/A'}</p>
                    <p><b>Tipo:</b> ${interaction.type}</p>
                    <p><b>Notas:</b> ${interaction.notes}</p>
                </li>
            `).join('');

            return `
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-bold border-b pb-2 mb-2">Información de Contacto</h3>
                        <p><b>Nombre:</b> ${customer.name}</p>
                        <p><b>DNI:</b> ${customer.dni}</p>
                        <p><b>Email:</b> ${customer.email}</p>
                        <p><b>Teléfono:</b> ${customer.phone}</p>
                        <p><b>Género:</b> ${customer.gender || 'N/A'}</p>
                        <p><b>Fecha de Nacimiento:</b> ${customer.birth_date ? new Date(customer.birth_date).toLocaleDateString() : 'N/A'}</p>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold border-b pb-2 mb-2">Historial de Compras</h3>
                        <ul class="list-disc pl-5">${salesHTML || '<li>No hay compras registradas.</li>'}</ul>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold border-b pb-2 mb-2">Historial de Interacciones</h3>
                        <ul class="list-disc pl-5">${interactionsHTML || '<li>No hay interacciones registradas.</li>'}</ul>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold border-b pb-2 mb-2">Añadir Interacción</h3>
                        <form onsubmit="window.app.handleSaveInteraction(event, '${customer.id}')" class="space-y-4">
                            <select name="type" class="border p-2 rounded w-full">
                                <option value="Llamada">Llamada</option>
                                <option value="Email">Email</option>
                                <option value="Visita">Visita</option>
                                <option value="Mantenimiento">Mantenimiento</option>
                            </select>
                            <textarea name="notes" placeholder="Notas de la interacción" class="border p-2 rounded w-full" rows="3" required></textarea>
                            <div class="flex flex-col">
                                <label for="followUpDate" class="text-sm text-gray-600">Agendar Seguimiento (Opcional)</label>
                                <input type="date" name="followUpDate" class="border p-2 rounded w-full" />
                            </div>
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Guardar Interacción</button>
                        </form>
                    </div>
                </div>
            `;
        }

        function PaginationHTML(collectionName, totalItems) {
            const { currentPage, itemsPerPage } = state.pagination[collectionName];
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            if (totalPages <= 1) return '';

            let pages = '';
            for (let i = 1; i <= totalPages; i++) {
                pages += `<button onclick="window.app.goToPage('${collectionName}', ${i})"
                                  class="px-3 py-1 border rounded ${i === currentPage ? 'bg-blue-500 text-white' : 'bg-white'}">
                            ${i}
                          </button>`;
            }

            return `
                <div class="flex justify-between items-center mt-4">
                    <button onclick="window.app.goToPage('${collectionName}', ${currentPage - 1})"
                            ${currentPage === 1 ? 'disabled' : ''}
                            class="px-3 py-1 border rounded bg-white disabled:opacity-50">
                        Anterior
                    </button>
                    <div class="flex space-x-1">${pages}</div>
                    <button onclick="window.app.goToPage('${collectionName}', ${currentPage + 1})"
                            ${currentPage === totalPages ? 'disabled' : ''}
                            class="px-3 py-1 border rounded bg-white disabled:opacity-50">
                        Siguiente
                    </button>
                </div>
            `;
        }

        function VehicleFormHTML(vehicle = {}) {
            return `
                <form onsubmit="window.app.handleSaveVehicle(event, '${vehicle.id || ''}')" class="space-y-4">
                    <input name="make" value="${vehicle.make || ''}" placeholder="Marca" class="border p-2 rounded w-full" />
                    <input name="model" value="${vehicle.model || ''}" placeholder="Modelo" class="border p-2 rounded w-full" />
                    <input name="trim" value="${vehicle.trim || ''}" placeholder="Nivel de Equipamiento (Trim)" class="border p-2 rounded w-full" />
                    <input name="vin" value="${vehicle.vin || ''}" placeholder="VIN" class="border p-2 rounded w-full" />
                    <input name="color" value="${vehicle.color || ''}" placeholder="Color" class="border p-2 rounded w-full" />
                    <input name="price" type="number" value="${vehicle.price || ''}" placeholder="Precio" class="border p-2 rounded w-full" />
                    <input name="engine_specs" value="${vehicle.engine_specs || ''}" placeholder="Especificaciones del Motor" class="border p-2 rounded w-full" />
                    <input name="installed_options" value="${vehicle.installed_options || ''}" placeholder="Opciones Instaladas (separadas por coma)" class="border p-2 rounded w-full" />
                    <input name="color_codes" value="${vehicle.color_codes || ''}" placeholder="Códigos de Color" class="border p-2 rounded w-full" />
                    <div class="flex flex-col">
                        <label for="fabrication_date" class="text-sm text-gray-600">Fecha de Fabricación</label>
                        <input name="fabrication_date" type="date" value="${vehicle.fabrication_date || ''}" class="border p-2 rounded w-full" />
                    </div>
                    <p class="text-sm text-gray-600">Estado actual: <span class="font-bold">${vehicle.status || 'N/A'}</span></p>
                    <div class="flex justify-end gap-4">
                        <button type="button" onclick="window.app.closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Guardar</button>
                    </div>
                </form>
            `;
        }
        function DealerFormHTML(dealer = {}) {
            return `
                 <form onsubmit="window.app.handleSaveDealer(event, '${dealer.id || ''}')" class="space-y-4">
                    <input name="name" value="${dealer.name || ''}" placeholder="Nombre" class="border p-2 rounded w-full" />
                    <input name="address" value="${dealer.address || ''}" placeholder="Dirección" class="border p-2 rounded w-full" />
                    <input name="territory" value="${dealer.territory || ''}" placeholder="Territorio" class="border p-2 rounded w-full" />
                    <input name="creditLine" type="number" value="${dealer.creditLine || ''}" placeholder="Línea de Crédito" class="border p-2 rounded w-full" />
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Crédito Disponible</label>
                        <input name="availableCredit" type="number" value="${dealer.availableCredit || ''}" placeholder="Crédito Disponible" class="border p-2 rounded w-full bg-gray-100" readonly />
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" onclick="window.app.closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Guardar</button>
                    </div>
                </form>
            `;
        }
        function CustomerFormHTML(customer = {}) {
            return `
                 <form onsubmit="window.app.handleSaveCustomer(event, '${customer.id || ''}')" class="space-y-4">
                    <input name="name" value="${customer.name || ''}" placeholder="Nombre Completo" class="border p-2 rounded w-full" />
                    <input name="dni" value="${customer.dni || ''}" placeholder="DNI" class="border p-2 rounded w-full" />
                    <input name="email" type="email" value="${customer.email || ''}" placeholder="Email" class="border p-2 rounded w-full" />
                    <input name="phone" value="${customer.phone || ''}" placeholder="Teléfono" class="border p-2 rounded w-full" />
                    <input name="gender" value="${customer.gender || ''}" placeholder="Género" class="border p-2 rounded w-full" />
                    <div class="flex flex-col">
                        <label for="birth_date" class="text-sm text-gray-600">Fecha de Nacimiento</label>
                        <input name="birth_date" type="date" value="${customer.birth_date || ''}" class="border p-2 rounded w-full" />
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" onclick="window.app.closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Cancelar</button>
                        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Guardar</button>
                    </div>
                </form>
            `;
        }
        
        // --- LÓGICA DE LA APLICACIÓN (Controladores) ---
        let salesChartInstance = null;
        const appController = {
            
            // --- Autenticación ---
            handleLogin: async (e) => {
                e.preventDefault();
                const button = document.getElementById('login-button');
                button.disabled = true;
                button.textContent = 'Iniciando...';
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    appController.setNotification({ type: 'error', message: 'Credenciales inválidas o error de red.' });
                    console.error("Error de inicio de sesión:", err);
                    button.disabled = false;
                    button.textContent = 'Iniciar Sesión';
                }
            },
            handleLogout: async () => {
                await signOut(auth);
            },
            
            // --- Notificaciones ---
            setNotification: (notif) => {
                state.notification = notif;
                renderNotification();
                setTimeout(() => appController.dismissNotification(), 5000);
            },
            dismissNotification: () => {
                if(state.notification.message){
                    state.notification = { message: '', type: '' };
                    renderNotification();
                }
            },

            // --- Navegación ---
            setCurrentPage: (page) => {
                state.currentPage = page;
                renderMainLayout();
            },

             // --- Lógica de CRUD y Acciones ---
            openVehicleModal: (vehicleId = null) => {
                const vehicleData = vehicleId ? state.collections.vehicles.find(v => v.id === vehicleId) : {};
                state.editingItem = { type: 'vehicle', data: vehicleData };
                state.isModalOpen = true;
                renderModal();
            },
            openDealerModal: (dealerId = null) => {
                 const dealerData = dealerId ? state.collections.dealers.find(d => d.id === dealerId) : {};
                 state.editingItem = { type: 'dealer', data: dealerData };
                 state.isModalOpen = true;
                 renderModal();
            },
            openCustomerModal: (customerId = null) => {
                 const customerData = customerId ? state.collections.customers.find(c => c.id === customerId) : {};
                 state.editingItem = { type: 'customer', data: customerData };
                 state.isModalOpen = true;
                 renderModal();
            },
            openCustomerDetailModal: (customerId) => {
                const customer = state.collections.customers.find(c => c.id === customerId);
                if (!customer) return;

                const customerSales = state.collections.sales
                    .filter(s => s.customerId === customerId)
                    .map(sale => {
                        const vehicle = state.collections.vehicles.find(v => v.id === sale.vehicleId);
                        return { ...sale, vehicle };
                    });

                const customerInteractions = state.collections.interactions.filter(i => i.customerId === customerId);

                state.editingItem = {
                    type: 'customerDetail',
                    data: {
                        customer,
                        sales: customerSales,
                        interactions: customerInteractions,
                    }
                };
                state.isModalOpen = true;
                renderModal();
            },
            closeModal: () => {
                state.isModalOpen = false;
                state.editingItem = null;
                renderModal();
            },
            updateVehicleFilter: (key, value) => {
                state.filters.vehicles[key] = value;
                renderCurrentPage();
            },
            updateVehicleStatusFilter: (status, isChecked) => {
                const statusSet = new Set(state.filters.vehicles.status);
                if (isChecked) {
                    statusSet.add(status);
                } else {
                    statusSet.delete(status);
                }
                state.filters.vehicles.status = Array.from(statusSet);
                renderCurrentPage();
            },
            handleSaveVehicle: async (e, vehicleId) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const vehicleData = Object.fromEntries(formData.entries());
                vehicleData.price = Number(vehicleData.price);
                if (vehicleData.fabrication_date) {
                    vehicleData.fabrication_date = new Date(vehicleData.fabrication_date).toISOString();
                }

                const saveVehicle = httpsCallable(functions, 'saveVehicle');
                try {
                    const result = await saveVehicle({ vehicleId: vehicleId || null, vehicleData });
                    appController.setNotification({ type: 'success', message: result.data.message });
                    appController.closeModal();
                } catch (error) {
                    appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                    console.error(error);
                }
            },
            handleDeleteVehicle: async (id) => {
                if (confirm('¿Estás seguro de que quieres eliminar este vehículo?')) {
                    const deleteVehicle = httpsCallable(functions, 'deleteVehicle');
                    try {
                        const result = await deleteVehicle({ vehicleId: id });
                        appController.setNotification({ type: 'success', message: result.data.message });
                    } catch (error) {
                        appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                        console.error(error);
                    }
                }
            },
            handleReceiveVehicle: async (vehicleId) => {
                if (confirm('¿Estás seguro de que quieres marcar este vehículo como recibido? El estado cambiará a "En Concesionario".')) {
                    const receiveVehicle = httpsCallable(functions, 'receiveVehicle');
                    try {
                        const result = await receiveVehicle({ vehicleId });
                        if (result.data.success) {
                            appController.setNotification({ type: 'success', message: result.data.message });
                        } else {
                            throw new Error(result.data.message);
                        }
                    } catch (error) {
                        appController.setNotification({ type: 'error', message: `Error al recibir el vehículo: ${error.message}` });
                        console.error(error);
                    }
                }
            },
            handleMarkInvoiceAsPaid: async (invoiceId) => {
                if (confirm('¿Estás seguro de que quieres marcar esta factura como pagada?')) {
                    const markInvoiceAsPaid = httpsCallable(functions, 'markInvoiceAsPaid');
                    try {
                        const result = await markInvoiceAsPaid({ invoiceId });
                        if (result.data.success) {
                            appController.setNotification({ type: 'success', message: result.data.message });
                        } else {
                            throw new Error(result.data.message);
                        }
                    } catch (error) {
                        appController.setNotification({ type: 'error', message: `Error al marcar la factura como pagada: ${error.message}` });
                        console.error(error);
                    }
                }
            },
            handleAssignDealer: async (vehicleId, dealerId) => {
                const assignDealer = httpsCallable(functions, 'assignDealer');
                try {
                    const result = await assignDealer({ vehicleId, dealerId });
                    appController.setNotification({ type: 'success', message: result.data.message });
                } catch (error) {
                    appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                    console.error(error);
                }
            },
            handleSaveDealer: async (e, dealerId) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const dealerData = Object.fromEntries(formData.entries());

                const saveDealer = httpsCallable(functions, 'saveDealer');
                try {
                    const result = await saveDealer({ dealerId: dealerId || null, dealerData });
                    appController.setNotification({ type: 'success', message: result.data.message });
                    appController.closeModal();
                } catch (error) {
                    appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                    console.error(error);
                }
            },
            handleDeleteDealer: async (id) => {
                if (confirm('¿Estás seguro?')) {
                    const deleteDealer = httpsCallable(functions, 'deleteDealer');
                    try {
                        const result = await deleteDealer({ dealerId: id });
                        appController.setNotification({ type: 'success', message: result.data.message });
                    } catch (error) {
                        appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                        console.error(error);
                    }
                }
            },
            handleSaveCustomer: async (e, customerId) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const customerData = Object.fromEntries(formData.entries());
                if (customerData.birth_date) {
                    customerData.birth_date = new Date(customerData.birth_date).toISOString();
                }
                
                const saveCustomer = httpsCallable(functions, 'saveCustomer');
                try {
                    const result = await saveCustomer({ customerId: customerId || null, customerData });
                    appController.setNotification({ type: 'success', message: result.data.message });
                    appController.closeModal();
                } catch(error) {
                    appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                    console.error(error);
                }
            },
            handleMatchFactoryOrder: async (factoryOrderId) => {
                const vehicleId = document.getElementById(`vehicle-for-${factoryOrderId}`).value;

                if (!vehicleId) {
                    appController.setNotification({ type: 'error', message: 'Por favor, selecciona un vehículo para emparejar.' });
                    return;
                }

                if (confirm('¿Estás seguro de que quieres emparejar este pedido con el vehículo seleccionado?')) {
                    const matchFactoryOrder = httpsCallable(functions, 'matchFactoryOrder');
                    try {
                        const result = await matchFactoryOrder({ factoryOrderId, vehicleId });
                        if (result.data.success) {
                            appController.setNotification({ type: 'success', message: result.data.message });
                        } else {
                            throw new Error(result.data.message);
                        }
                    } catch (error) {
                        appController.setNotification({ type: 'error', message: `Error al emparejar el pedido: ${error.message}` });
                        console.error(error);
                    }
                }
            },
            handleCreateFactoryOrder: async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const orderData = Object.fromEntries(formData.entries());

                const createFactoryOrder = httpsCallable(functions, 'createFactoryOrder');
                try {
                    const result = await createFactoryOrder({ orderData });
                    appController.setNotification({ type: 'success', message: result.data.message });
                    e.target.reset();
                } catch (error) {
                    appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                    console.error(error);
                }
            },
            handleDeleteCustomer: async(id) => {
                if(confirm('¿Estás seguro?')){
                    const deleteCustomer = httpsCallable(functions, 'deleteCustomer');
                    try {
                        const result = await deleteCustomer({ customerId: id });
                        appController.setNotification({ type: 'success', message: result.data.message });
                    } catch (error) {
                        appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                        console.error(error);
                    }
                }
            },
            handleSaveInteraction: async (e, customerId) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const interactionData = Object.fromEntries(formData.entries());

                if (!interactionData.notes) {
                    appController.setNotification({ type: 'error', message: 'Las notas no pueden estar vacías.' });
                    return;
                }

                if (interactionData.followUpDate) {
                    interactionData.followUpDate = new Date(interactionData.followUpDate).toISOString();
                }

                const saveInteraction = httpsCallable(functions, 'saveInteraction');
                try {
                    await saveInteraction({ customerId, interactionData });
                    appController.setNotification({ type: 'success', message: 'Interacción guardada.' });
                    e.target.reset();
                } catch (error) {
                    appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                    console.error(error);
                }
            },
            handleConfirmOrder: async (vehicleId) => {
                if (confirm('¿Estás seguro de que quieres confirmar este pedido? El vehículo pasará a estado "En Tránsito".')) {
                    const confirmOrder = httpsCallable(functions, 'handleConfirmOrder');
                    try {
                        const result = await confirmOrder({ vehicleId });
                        if (result.data.success) {
                            appController.setNotification({ type: 'success', message: result.data.message });
                        } else {
                            throw new Error(result.data.message);
                        }
                    } catch (error) {
                        appController.setNotification({ type: 'error', message: `Error al confirmar el pedido: ${error.message}` });
                        console.error(error);
                    }
                }
            },
            toggleNewCustomerSale: (isChecked) => {
                state.isNewCustomerSale = isChecked;
                const container = document.getElementById('customer-form-container');
                if (container) {
                     container.innerHTML = isChecked ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border rounded-md">
                            <input name="name" placeholder="Nombre Completo" class="p-2 border rounded" />
                            <input name="dni" placeholder="DNI" class="p-2 border rounded" />
                            <input name="email" type="email" placeholder="Email" class="p-2 border rounded" />
                            <input name="phone" placeholder="Teléfono" class="p-2 border rounded" />
                        </div>
                    ` : `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Cliente Existente</label>
                            <select name="customerId" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                <option value="" disabled selected>Seleccione un cliente</option>
                                ${state.collections.customers.map(c => `<option value="${c.id}">${c.name} (${c.dni})</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
            },
            handleRegisterSale: async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                const salePayload = {
                    vehicleId: data.vehicleId,
                    customerId: data.customerId,
                    finalPrice: data.finalPrice,
                    financing_method: data.financing_method,
                    trade_in_make: data.trade_in_make,
                    trade_in_model: data.trade_in_model,
                    trade_in_vin: data.trade_in_vin,
                    trade_in_value: data.trade_in_value,
                };
                
                if (state.isNewCustomerSale) {
                    salePayload.newCustomerData = {
                        name: data.name,
                        dni: data.dni,
                        email: data.email,
                        phone: data.phone,
                        gender: data.gender,
                        birth_date: data.birth_date ? new Date(data.birth_date).toISOString() : null,
                    };
                }

                const registerSale = httpsCallable(functions, 'registerSale');
                try {
                    const result = await registerSale({ salePayload });
                    appController.setNotification({ type: 'success', message: result.data.message });
                    state.isNewCustomerSale = false;
                    renderCurrentPage();
                } catch (error) {
                    appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                    console.error("Error registrando venta:", error);
                }
            },

            renderSalesReport: () => {
                const sales = state.collections.sales;
                if (!sales.length) return;

                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');

                if(!startDateInput || !endDateInput) return;

                const startDate = startDateInput.value;
                const endDate = endDateInput.value;

                const filteredSales = sales.filter(s => {
                    if (!s.saleDate) return false;
                    const saleDate = s.saleDate.toDate();
                    if (startDate && saleDate < new Date(startDate)) return false;
                    if (endDate && saleDate > new Date(endDate)) return false;
                    return true;
                });

                const salesByMonth = filteredSales.reduce((acc, sale) => {
                    if (!sale.saleDate) return acc;
                    const month = sale.saleDate.toDate().toISOString().slice(0, 7); // YYYY-MM
                    acc[month] = (acc[month] || 0) + 1;
                    return acc;
                }, {});

                const labels = Object.keys(salesByMonth).sort();
                const data = labels.map(label => salesByMonth[label]);

                const ctx = document.getElementById('salesChart');
                if (!ctx) return;

                if (salesChartInstance) {
                    salesChartInstance.destroy();
                }

                salesChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Número de Ventas',
                            data: data,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },

            exportToCSV: (data, filename) => {
                if (!data.length) {
                    appController.setNotification({ type: 'error', message: 'No hay datos para exportar.' });
                    return;
                }

                const replacer = (key, value) => value === null ? '' : value;
                const header = Object.keys(data[0]);
                let csv = data.map(row => header.map(fieldName => {
                    let fieldValue = row[fieldName];
                    if (typeof fieldValue === 'object' && fieldValue !== null && fieldValue.toDate) {
                        fieldValue = fieldValue.toDate().toLocaleString();
                    }
                    return JSON.stringify(fieldValue, replacer);
                }).join(','));
                csv.unshift(header.join(','));
                csv = csv.join('\r\n');

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            },
            goToPage: (collectionName, page) => {
                const { itemsPerPage } = state.pagination[collectionName];
                const totalItems = state.collections[collectionName].length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);

                if (page < 1 || page > totalPages) return;

                state.pagination[collectionName].currentPage = page;
                renderCurrentPage();
            },
            toggleTableDensity: () => {
                state.ui.tableDensity = state.ui.tableDensity === 'default' ? 'compact' : 'default';
                renderCurrentPage();
            },
            toggleVehicleColumn: (columnName) => {
                const visibleColumns = new Set(state.ui.visibleVehicleColumns);
                if (visibleColumns.has(columnName)) {
                    visibleColumns.delete(columnName);
                } else {
                    visibleColumns.add(columnName);
                }
                state.ui.visibleVehicleColumns = Array.from(visibleColumns);
                renderCurrentPage();
            },
            calculateAverageDaysInStock: () => {
                const soldVehicles = state.collections.vehicles.filter(v => v.status === 'vendido');
                if (!soldVehicles.length) return 0;

                let totalDays = 0;
                let count = 0;

                soldVehicles.forEach(vehicle => {
                    if (!vehicle.statusHistory) return;

                    const arrivalEntry = vehicle.statusHistory.find(h => h.status === 'enConcesionario');
                    const saleEntry = vehicle.statusHistory.find(h => h.status === 'vendido');

                    if (arrivalEntry && saleEntry && arrivalEntry.date && saleEntry.date) {
                        const arrivalDate = arrivalEntry.date.toDate();
                        const saleDate = saleEntry.date.toDate();
                        const diffTime = Math.abs(saleDate - arrivalDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        totalDays += diffDays;
                        count++;
                    }
                });

                return count > 0 ? (totalDays / count).toFixed(1) : 0;
            },
            calculateAvgDaysInStockForDealer: (dealerId) => {
                const soldVehicles = state.collections.sales
                    .filter(s => s.dealerId === dealerId)
                    .map(s => state.collections.vehicles.find(v => v.id === s.vehicleId && v.status === 'vendido'))
                    .filter(Boolean);

                if (!soldVehicles.length) return 0;
                let totalDays = 0;
                let count = 0;
                soldVehicles.forEach(vehicle => {
                    if (!vehicle.statusHistory) return;
                    const arrivalEntry = vehicle.statusHistory.find(h => h.status === 'enConcesionario');
                    const saleEntry = vehicle.statusHistory.find(h => h.status === 'vendido');
                    if (arrivalEntry && saleEntry && arrivalEntry.date && saleEntry.date) {
                        totalDays += Math.ceil(Math.abs(saleEntry.date.toDate() - arrivalEntry.date.toDate()) / (1000 * 60 * 60 * 24));
                        count++;
                    }
                });
                return count > 0 ? (totalDays / count).toFixed(1) : 0;
            },
            calculateAvgDaysInStockForTerritory: (territory) => {
                const dealersInTerritory = state.collections.dealers.filter(d => d.territory === territory).map(d => d.id);
                const soldVehicles = state.collections.sales
                    .filter(s => dealersInTerritory.includes(s.dealerId))
                    .map(s => state.collections.vehicles.find(v => v.id === s.vehicleId && v.status === 'vendido'))
                    .filter(Boolean);

                if (!soldVehicles.length) return 0;
                let totalDays = 0;
                let count = 0;
                 soldVehicles.forEach(vehicle => {
                    if (!vehicle.statusHistory) return;
                    const arrivalEntry = vehicle.statusHistory.find(h => h.status === 'enConcesionario');
                    const saleEntry = vehicle.statusHistory.find(h => h.status === 'vendido');
                    if (arrivalEntry && saleEntry && arrivalEntry.date && saleEntry.date) {
                        totalDays += Math.ceil(Math.abs(saleEntry.date.toDate() - arrivalEntry.date.toDate()) / (1000 * 60 * 60 * 24));
                        count++;
                    }
                });
                return count > 0 ? (totalDays / count).toFixed(1) : 0;
            },
            calculateInventoryTurnoverRate: () => {
                const ninetyDaysAgo = new Date();
                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

                const salesInPeriod = state.collections.sales.filter(s => s.saleDate && s.saleDate.toDate() > ninetyDaysAgo).length;
                const currentStock = state.collections.vehicles.filter(v => v.status !== 'vendido').length;

                if (currentStock === 0) return 'N/A';
                return (salesInPeriod / currentStock).toFixed(2);
            },
            calculateSalesByTerritory: () => {
                const salesByTerritory = state.collections.sales.reduce((acc, sale) => {
                    const dealer = state.collections.dealers.find(d => d.id === sale.dealerId);
                    if (dealer && dealer.territory) {
                        acc[dealer.territory] = (acc[dealer.territory] || 0) + 1;
                    }
                    return acc;
                }, {});
                return salesByTerritory;
            },
            renderBITopCharts: () => {
                const salesByTerritoryData = appController.calculateSalesByTerritory();
                const labels = Object.keys(salesByTerritoryData);
                const data = Object.values(salesByTerritoryData);

                const ctx = document.getElementById('salesByTerritoryChart');
                if (!ctx) return;

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ventas Totales',
                            data: data,
                            backgroundColor: 'rgba(22, 163, 74, 0.6)',
                            borderColor: 'rgba(22, 163, 74, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            },
            renderDealerSalesChart: () => {
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);

                const dealerSales = state.collections.sales.filter(s =>
                    s.dealerId === state.userClaims.dealerId &&
                    s.saleDate &&
                    s.saleDate.toDate() > sixMonthsAgo
                );

                const salesByMonth = dealerSales.reduce((acc, sale) => {
                    const month = sale.saleDate.toDate().toISOString().slice(0, 7); // YYYY-MM
                    acc[month] = (acc[month] || 0) + 1;
                    return acc;
                }, {});

                const labels = [];
                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    labels.push(d.toISOString().slice(0, 7));
                }

                const data = labels.map(label => salesByMonth[label] || 0);

                const ctx = document.getElementById('dealerSalesChart');
                if (!ctx) return;

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Mis Ventas',
                            data: data,
                            borderColor: 'rgba(79, 70, 229, 1)',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                });
            },
            handleSaveForecast: async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const forecastData = {
                    month: formData.get('month'),
                    target: Number(formData.get('target')),
                };

                const saveForecast = httpsCallable(functions, 'saveForecast');
                try {
                    const result = await saveForecast({ forecastData });
                    appController.setNotification({ type: 'success', message: result.data.message });
                    e.target.reset();
                } catch (error) {
                    appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                    console.error(error);
                }
            },
            handleCompleteFollowUp: async (interactionId) => {
                const completeFollowUp = httpsCallable(functions, 'completeFollowUp');
                try {
                    const result = await completeFollowUp({ interactionId });
                    appController.setNotification({ type: 'success', message: result.data.message });
                } catch (error) {
                    appController.setNotification({ type: 'error', message: `Error: ${error.message}` });
                    console.error(error);
                }
            },
        };

        // --- INICIALIZACIÓN Y SUSCRIPCIONES ---
        
        function mainRender() {
            if (state.authLoading) {
                appContainer.innerHTML = `<div class="min-h-screen flex items-center justify-center">${SpinnerHTML()}</div>`;
            } else if (state.user && state.role) {
                renderMainLayout();
            } else {
                renderLoginPage();
            }
        }
        
        function renderNotification() {
            const container = document.getElementById('notification-container') || appContainer;
            if(container) container.innerHTML = NotificationHTML();
        }

        function setupFirestoreListeners() {
            // Limpiar listeners anteriores
            firestoreUnsubscribers.forEach(unsub => unsub());
            firestoreUnsubscribers = [];

            const collectionsToWatch = ['dealers', 'customers', 'sales', 'b2b_invoices', 'forecasts', 'factory_orders'];
            
            collectionsToWatch.forEach(name => {
                const unsub = onSnapshot(collection(db, name), snapshot => {
                    state.collections[name] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    state.collectionsLoading[name] = false;
                    if(state.currentPage === name || state.currentPage === 'dashboard') renderCurrentPage();
                });
                firestoreUnsubscribers.push(unsub);
            });

            // Listener for interactions, with special logic to refresh the customer detail modal
            const unsubInteractions = onSnapshot(collection(db, 'interactions'), snapshot => {
                state.collections.interactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.collectionsLoading.interactions = false;
                if (state.isModalOpen && state.editingItem && state.editingItem.type === 'customerDetail') {
                    appController.openCustomerDetailModal(state.editingItem.data.customer.id);
                }
            });
            firestoreUnsubscribers.push(unsubInteractions);
            
            // Listener de vehículos con query condicional
            let vehicleConstraints = [];
            if (state.role === 'dealer' && state.userClaims?.dealerId) {
                vehicleConstraints.push(where('dealerId', '==', state.userClaims.dealerId));
            }
            const vehicleQuery = query(collection(db, 'vehicles'), ...vehicleConstraints);
            const unsubVehicles = onSnapshot(vehicleQuery, snapshot => {
                state.collections.vehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.collectionsLoading.vehicles = false;
                if(state.currentPage === 'vehicles' || state.currentPage === 'dashboard') renderCurrentPage();
            });
            firestoreUnsubscribers.push(unsubVehicles);

            // Listener para vehículos disponibles para venta
            let availableVehicleConstraints = [where('status', '==', 'enConcesionario')];
             if (state.role === 'dealer' && state.userClaims?.dealerId) {
                availableVehicleConstraints.push(where('dealerId', '==', state.userClaims.dealerId));
            }
            const availableVehicleQuery = query(collection(db, 'vehicles'), ...availableVehicleConstraints);
            const unsubAvailable = onSnapshot(availableVehicleQuery, snapshot => {
                state.collections.availableVehicles = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.collectionsLoading.availableVehicles = false;
                if(state.currentPage === 'sales') renderCurrentPage();
            });
             firestoreUnsubscribers.push(unsubAvailable);

        }

        // --- PUNTO DE ENTRADA ---
        onAuthStateChanged(auth, async (firebaseUser) => {
            if (firebaseUser) {
                const idTokenResult = await firebaseUser.getIdTokenResult(true);
                const claims = idTokenResult.claims;
                state.user = firebaseUser;
                // --- CAMBIO CLAVE ---
                // --- CAMBIO DE SEGURIDAD CRÍTICO ---
                // Se elimina el fallback a 'dealer'. Si un usuario no tiene un rol en sus Custom Claims,
                // no se le asignará ninguno y no podrá acceder a las funcionalidades.
                state.role = claims.role || null;
                state.userClaims = claims;
                setupFirestoreListeners();
            } else {
                state.user = null;
                state.role = null;
                state.userClaims = null;
                firestoreUnsubscribers.forEach(unsub => unsub());
                firestoreUnsubscribers = [];
            }
            state.authLoading = false;
            mainRender();
        });

        // Exponer el controlador al objeto window para los eventos inline
        window.app = appController;
        
    </script>
</body>
</html>



